<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>VR Snow Island</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
  </head>
  <body>
    <a-scene physics="gravity: -9.8" vr-mode-ui="enabled: true" embedded background="color: #cceeff">

      <!-- Sky -->
      <a-sky color="#cceeff"></a-sky>

      <!-- Lighting -->
      <a-light type="ambient" color="#ffffff" intensity="0.7"></a-light>
      <a-light type="directional" position="0 10 5" intensity="0.6" castShadow="true"></a-light>

      <!-- 3D Snow Terrain (using a plane + displacement for "mountains") -->
      <a-entity geometry="primitive: plane; width: 100; height: 100; segmentsWidth: 50; segmentsHeight: 50"
                rotation="-90 0 0"
                material="color: #eef2ff; wireframe: false"
                id="terrain"
                static-body>
      </a-entity>

      <!-- Player Camera + Controls + Smooth Flying -->
      <a-entity id="player" camera look-controls wasd-controls position="0 2 10">
        <a-entity 
          cursor="fuse: false; rayOrigin: mouse"
          position="0 0 -0.5"
          geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
          material="color: black; shader: flat">
        </a-entity>
      </a-entity>

      <!-- Smooth Flight Script -->
      <script>
        AFRAME.registerComponent('fly-controls', {
          schema: {speed: {type: 'number', default: 0.2}},
          init: function () { this.velocity = 0; },
          tick: function () {
            const el = this.el;
            const pos = el.getAttribute('position');
            // WASD movement plus flying (Space = up, Shift = down)
            let move = new THREE.Vector3();
            if (window.keysPressed) {
              if(keysPressed['w']) move.z -= 1;
              if(keysPressed['s']) move.z += 1;
              if(keysPressed['a']) move.x -= 1;
              if(keysPressed['d']) move.x += 1;
              if(keysPressed[' ']) move.y += 1; // Space
              if(keysPressed['Shift']) move.y -= 1; // Shift
            }
            move.multiplyScalar(this.data.speed);
            el.setAttribute('position', {x: pos.x+move.x, y: pos.y+move.y, z: pos.z+move.z});
          }
        });

        window.keysPressed = {};
        window.addEventListener('keydown', e => keysPressed[e.key] = true);
        window.addEventListener('keyup', e => keysPressed[e.key] = false);
        document.querySelector('#player').setAttribute('fly-controls', '');
      </script>

      <!-- Snowballs (Grabbable + Throw) -->
      <a-sphere position="2 1 -3" radius="0.3" color="#ffffff" dynamic-body grabbable></a-sphere>
      <a-sphere position="-3 1 -4" radius="0.3" color="#ffffff" dynamic-body grabbable></a-sphere>

      <!-- NPC -->
      <a-box id="npc" position="5 0.5 -5" color="#ffcc00" depth="1" height="1" width="1" dynamic-body></a-box>

      <!-- NPC Behavior Script -->
      <script>
        AFRAME.registerComponent('npc-follow', {
          schema: {speed: {type: 'number', default: 0.02}},
          tick: function () {
            const player = document.querySelector('#player');
            const npc = this.el;
            const pPos = player.getAttribute('position');
            const nPos = npc.getAttribute('position');

            let dx = pPos.x - nPos.x;
            let dz = pPos.z - nPos.z;
            let dist = Math.sqrt(dx*dx + dz*dz);

            if(dist > 1){
              npc.setAttribute('position', {
                x: nPos.x + dx*this.data.speed,
                y: nPos.y,
                z: nPos.z + dz*this.data.speed
              });
            }
          }
        });
        document.querySelector('#npc').setAttribute('npc-follow', '');
      </script>

      <!-- Snow Particle System -->
      <a-entity particle-system="preset: snow; particleCount: 2000; size: 0.1; color: #ffffff; velocityY: -0.5"></a-entity>

    </a-scene>
  </body>
</html>
