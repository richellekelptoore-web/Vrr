<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Snow Island VR</title>
  <style>body{margin:0;overflow:hidden}canvas{display:block}</style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/three@0.154.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.154.0/examples/jsm/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.154.0/examples/jsm/webxr/VRButton.js"></script>
<script>
let scene = new THREE.Scene();
scene.background = new THREE.Color(0x88ccff);
let camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 1000);
let renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
renderer.xr.enabled = true;
document.body.appendChild(renderer.domElement);
document.body.appendChild(VRButton.createButton(renderer));

// Lights
scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1.0));
let dir = new THREE.DirectionalLight(0xffffff,0.8); dir.position.set(5,10,2); scene.add(dir);

// Island
let island = new THREE.Mesh(
  new THREE.CylinderGeometry(12,18,4,32),
  new THREE.MeshStandardMaterial({color:0xeeeeff})
);
island.position.y = -2; island.receiveShadow = true; scene.add(island);

// Snow layer
let snowMat = new THREE.MeshStandardMaterial({color:0xffffff});
let snow = new THREE.Mesh(new THREE.CircleGeometry(11,32), snowMat);
snow.rotation.x = -Math.PI/2; snow.position.y = 0.01; scene.add(snow);

// Snow particle system
let particles = new THREE.BufferGeometry();
let count = 800;
let pos = new Float32Array(count*3);
for(let i=0;i<count;i++){
  pos[3*i] = (Math.random()-0.5)*30;
  pos[3*i+1] = Math.random()*15 + 2;
  pos[3*i+2] = (Math.random()-0.5)*30;
}
particles.setAttribute('position', new THREE.BufferAttribute(pos,3));
let pMat = new THREE.PointsMaterial({color:0xffffff, size:0.12, transparent:true, opacity:0.9});
let snowPoints = new THREE.Points(particles,pMat); scene.add(snowPoints);

// Player rig
let rig = new THREE.Group(); rig.add(camera); scene.add(rig);
camera.position.set(0,1.6,3);

// Simple NPC
let npc = new THREE.Mesh(new THREE.BoxGeometry(0.6,1.2,0.4), new THREE.MeshStandardMaterial({color:0xff6666}));
npc.position.set(4,0.6,0); scene.add(npc);
let npcTarget = new THREE.Vector3(-4,0.6,0);

// Pickup object
let box = new THREE.Mesh(new THREE.BoxGeometry(0.4,0.4,0.4), new THREE.MeshStandardMaterial({color:0x66ccff}));
box.position.set(0,0.2,-2); scene.add(box);
box.userData.pickable = true;

// Controllers and raycast pickup
let controller = renderer.xr.getController(0);
controller.addEventListener('selectstart', onSelectStart);
controller.addEventListener('selectend', onSelectEnd);
scene.add(controller);
let tempMatrix = new THREE.Matrix4();
let grabbed = null;

function onSelectStart(){ tempMatrix.identity().extractRotation(controller.matrixWorld);
  let ray = new THREE.Raycaster(); ray.ray.origin.setFromMatrixPosition(controller.matrixWorld);
  ray.ray.direction.set(0,0,-1).applyMatrix4(tempMatrix);
  let hits = ray.intersectObjects(scene.children, true);
  if(hits.length && hits[0].object.userData.pickable){ grabbed = hits[0].object; controller.add(grabbed); grabbed.position.set(0,0,-0.3); }
}
function onSelectEnd(){ if(grabbed){ scene.add(grabbed); grabbed.position.setFromMatrixPosition(controller.matrixWorld); grabbed = null; }}

// Flight toggle
let flying = false;
window.addEventListener('keydown', e=>{ if(e.key==='f') flying=!flying; });

// Animation loop
renderer.setAnimationLoop(()=> {
  // snow fall
  let p = snowPoints.geometry.attributes.position.array;
  for(let i=0;i<count;i++){
    p[3*i+1] -= 0.02;
    if(p[3*i+1] < -1) p[3*i+1] = Math.random()*15 + 8;
  }
  snowPoints.geometry.attributes.position.needsUpdate = true;

  // NPC simple patrol
  npc.position.lerp(npcTarget, 0.01);
  if(npc.position.distanceTo(npcTarget) < 0.2) npcTarget.x *= -1;

  // flight
  if(flying) rig.position.y += 0.05; else if(rig.position.y>0) rig.position.y -= 0.05;

  renderer.render(scene, camera);
});
</script>
</body>
</html>
